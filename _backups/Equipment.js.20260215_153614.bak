import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { supabase, supabaseConfigOk } from '../lib/supabase';
import { useAuth } from '../context/AuthContext';

const TABS = [
  { key: 'all', label: 'All' },
  { key: 'available', label: 'Available' },
  { key: 'in_use', label: 'In Use' },
  { key: 'overdue', label: 'Overdue' },
  { key: 'expired', label: 'Expired Tags' },
  { key: 'due_soon', label: 'Due Soon' },
];

function fmtLocal(dt) {
  if (!dt) return '-';
  try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
}

export default function Equipment() {
  const { user, loading, isAdmin } = useAuth();

  const [tab, setTab] = useState('all');
  const [q, setQ] = useState('');
  const [rows, setRows] = useState([]);
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState(null);

  const load = useCallback(async () => {
    setErr(null);

    // Always clear UI state on early exits
    if (loading) { setBusy(false); return; }
    if (!user) { setBusy(false); setRows([]); return; }

    if (!supabaseConfigOk) {
      setBusy(false);
      setErr('Missing REACT_APP_SUPABASE_URL or REACT_APP_SUPABASE_ANON_KEY');
      setRows([]);
      return;
    }

    setBusy(true);

    // Hard timeout so "Loading…" can’t hang forever
    const ac = new AbortController();
    const timer = setTimeout(() => ac.abort(), 12000);

    try {
      const { data, error } = await supabase
        .from('equipment_current_status')
        .select('id,asset_id,qr_code_value,name,category,condition,notes,test_tag_done_date,test_tag_next_due_date,primary_photo_url,computed_status,test_tag_state,checked_out_to,site,expected_return_at,checked_out_at,created_at')
        .order('created_at', { ascending: false })
        .abortSignal(ac.signal);

      if (error) {
        setErr(JSON.stringify(error, null, 2));
        setRows([]);
      } else {
        setRows(Array.isArray(data) ? data : []);
      }
    } catch (e) {
      const msg =
        e?.name === 'AbortError'
          ? 'Request timed out (12s) talking to Supabase.'
          : String(e?.message || e);
      setErr(msg);
      setRows([]);
    } finally {
      clearTimeout(timer);
      setBusy(false);
    }
  }, [loading, user]);

  useEffect(() => {
    if (!loading && user) load();
    if (!loading && !user) { setBusy(false); setRows([]); setErr(null); }
  }, [loading, user, load]);

  const filtered = useMemo(() => {
    const query = (q || '').trim().toLowerCase();
    let r = rows;

    if (tab === 'available') r = r.filter(x => x.computed_status === 'available');
    if (tab === 'in_use') r = r.filter(x => x.computed_status === 'in_use');
    if (tab === 'overdue') r = r.filter(x => x.computed_status === 'overdue');
    if (tab === 'expired') r = r.filter(x => x.test_tag_state === 'expired');
    if (tab === 'due_soon') r = r.filter(x => x.test_tag_state === 'due_soon');

    if (!query) return r;

    return r.filter(x => {
      const hay = [
        x.asset_id,
        x.name,
        x.category,
        x.qr_code_value,
        x.site,
        x.checked_out_to,
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(query);
    });
  }, [rows, tab, q]);

  const counts = useMemo(() => {
    const total = rows.length;
    const inUse = rows.filter(r => r.computed_status === 'in_use').length;
    const overdue = rows.filter(r => r.computed_status === 'overdue').length;
    const expired = rows.filter(r => r.test_tag_state === 'expired').length;
    return { total, inUse, overdue, expired };
  }, [rows]);

  const debug = useMemo(() => {
    return "loading=" + String(loading) + " user=" + (user ? user.email : "null") + " rows=" + rows.length;
  }, [loading, user, rows.length]);

  return (
    <div style={{ padding: 24 }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', gap: 16, flexWrap: 'wrap' }}>
        <div>
          <h1 style={{ margin: 0 }}>Equipment</h1>
          <div style={{ color: '#6b7280', marginTop: 4 }}>
            {isAdmin ? 'Admin access' : 'Read-only user'}
          </div>
          <div style={{ color: '#9ca3af', marginTop: 6, fontSize: 12 }}>
            debug: {debug}
          </div>
        </div>

        <div style={{ display: 'flex', gap: 12, alignItems: 'center', flexWrap: 'wrap' }}>
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            placeholder="Search tools..."
            style={{ width: 320, maxWidth: '90vw', padding: '10px 12px', border: '1px solid #d1d5db', borderRadius: 8 }}
          />
          <button
            onClick={load}
            style={{ padding: '10px 14px', borderRadius: 8, border: '1px solid #d1d5db', background: 'white', cursor: 'pointer', fontWeight: 600 }}
          >
            Refresh
          </button>
        </div>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, minmax(180px, 1fr))', gap: 12, marginTop: 16 }}>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>Total Tools</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.total}</div>
        </div>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>In Use</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.inUse}</div>
        </div>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>Overdue</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.overdue}</div>
        </div>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>Expired Tags</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.expired}</div>
        </div>
      </div>

      <div style={{ display: 'flex', gap: 8, marginTop: 16, flexWrap: 'wrap' }}>
        {TABS.map(t => (
          <button
            key={t.key}
            onClick={() => setTab(t.key)}
            style={{
              padding: '8px 12px',
              borderRadius: 999,
              border: '1px solid #d1d5db',
              background: tab === t.key ? '#111827' : 'white',
              color: tab === t.key ? 'white' : '#111827',
              cursor: 'pointer',
              fontWeight: 600
            }}
          >
            {t.label}
          </button>
        ))}
      </div>

      {busy && rows.length === 0 && <div style={{ marginTop: 16 }}>Loading…</div>}

      {err && (
        <div style={{ marginTop: 16, background: '#fee2e2', border: '1px solid #fecaca', color: '#991b1b', padding: 12, borderRadius: 10 }}>
          <div style={{ fontWeight: 800 }}>Data load failed</div>
          <div style={{ marginTop: 4, fontSize: 13, whiteSpace: 'pre-wrap' }}>{err}</div>
        </div>
      )}

      {!busy && !err && (
        <div style={{ marginTop: 16, display: 'grid', gap: 12 }}>
          {filtered.map(item => (
            <div key={item.id} style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', gap: 12, flexWrap: 'wrap' }}>
                <div>
                  <div style={{ fontWeight: 800 }}>{item.name}</div>
                  <div style={{ color: '#6b7280', marginTop: 2 }}>
                    Asset: {item.asset_id} · Category: {item.category || '-'} · Status: {item.computed_status}
                  </div>
                </div>

                <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                  {item.test_tag_state && (
                    <span style={{ fontSize: 12, padding: '4px 10px', borderRadius: 999, border: '1px solid #d1d5db' }}>
                      Tag: {item.test_tag_state}
                    </span>
                  )}
                </div>
              </div>

              {(item.computed_status !== 'available') && (
                <div style={{ marginTop: 10, color: '#374151', fontSize: 14 }}>
                  Checked out to <b>{item.checked_out_to || '-'}</b> at <b>{item.site || '-'}</b>. Expected return: <b>{fmtLocal(item.expected_return_at)}</b>
                </div>
              )}
            </div>
          ))}

          {filtered.length === 0 && (
            <div style={{ color: '#6b7280' }}>No tools found (database currently empty).</div>
          )}
        </div>
      )}
    </div>
  );
}
