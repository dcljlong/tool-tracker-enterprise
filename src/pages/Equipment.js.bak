import React, { useEffect, useMemo, useState } from 'react';
import { supabase } from '../lib/supabase';
import { useAuth } from '../context/AuthContext';

const TABS = [
  { key: 'all', label: 'All' },
  { key: 'available', label: 'Available' },
  { key: 'in_use', label: 'In Use' },
  { key: 'overdue', label: 'Overdue' },
  { key: 'expired', label: 'Expired Tags' },
  { key: 'due_soon', label: 'Due Soon' },
];

function withTimeout(promise, ms) {
  let t;
  const timeout = new Promise((_, reject) => {
    t = setTimeout(() => reject(new Error('Request timed out')), ms);
  });
  return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
}

export default function Equipment() {
  const { user, loading, isAdmin } = useAuth();

  const [tab, setTab] = useState('all');
  const [q, setQ] = useState('');
  const [rows, setRows] = useState([]);
  const [busy, setBusy] = useState(true);
  const [err, setErr] = useState(null);

  const load = async () => {
    setBusy(true);
    setErr(null);

    // If user isn't ready yet, don't hang on Loading forever
    if (!user) {
      setBusy(false);
      return;
    }

    try {
      const req = supabase
        .from('equipment_current_status')
        .select('id,asset_id,qr_code_value,name,category,condition,notes,test_tag_done_date,test_tag_next_due_date,primary_photo_url,computed_status,test_tag_state,checked_out_to,site,expected_return_at,checked_out_at,created_at')
        .order('created_at', { ascending: false });

      const { data, error } = await withTimeout(req, 10000);

      if (error) {
        setErr(JSON.stringify(error, null, 2));
        setRows([]);
      } else {
        setRows(data || []);
      }
    } catch (e) {
      setErr(String(e?.message || e));
      setRows([]);
    } finally {
      setBusy(false);
    }
  };

  useEffect(() => {
    if (loading) return;
    load();
    // eslint-disable-next-line
  }, [loading, user]);

  const filtered = useMemo(() => {
    const query = (q || '').trim().toLowerCase();
    let r = rows;

    if (tab === 'available') r = r.filter(x => x.computed_status === 'available');
    if (tab === 'in_use') r = r.filter(x => x.computed_status === 'in_use');
    if (tab === 'overdue') r = r.filter(x => x.computed_status === 'overdue');
    if (tab === 'expired') r = r.filter(x => x.test_tag_state === 'expired');
    if (tab === 'due_soon') r = r.filter(x => x.test_tag_state === 'due_soon');

    if (!query) return r;

    return r.filter(x => {
      const hay = [
        x.asset_id,
        x.name,
        x.category,
        x.qr_code_value,
        x.site,
        x.checked_out_to,
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(query);
    });
  }, [rows, tab, q]);

  const counts = useMemo(() => {
    const total = rows.length;
    const inUse = rows.filter(r => r.computed_status === 'in_use').length;
    const overdue = rows.filter(r => r.computed_status === 'overdue').length;
    const expired = rows.filter(r => r.test_tag_state === 'expired').length;
    return { total, inUse, overdue, expired };
  }, [rows]);

  return (
    <div style={{ padding: 24 }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', gap: 16, flexWrap: 'wrap' }}>
        <div>
          <h1 style={{ margin: 0 }}>Equipment</h1>
          <div style={{ color: '#6b7280', marginTop: 4 }}>
            {isAdmin ? 'Admin access' : 'Read-only user'}
          </div>
          <div style={{ color: '#9ca3af', marginTop: 6, fontSize: 12 }}>
            debug: loading={String(loading)} · user={user?.email || 'null'}
          </div>
        </div>

        <div style={{ display: 'flex', gap: 12, alignItems: 'center', flexWrap: 'wrap' }}>
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            placeholder="Search tools..."
            style={{ width: 320, maxWidth: '90vw', padding: '10px 12px', border: '1px solid #d1d5db', borderRadius: 8 }}
          />
          <button
            onClick={load}
            style={{ padding: '10px 14px', borderRadius: 8, border: '1px solid #d1d5db', background: 'white', cursor: 'pointer', fontWeight: 600 }}
          >
            Refresh
          </button>
        </div>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, minmax(180px, 1fr))', gap: 12, marginTop: 16 }}>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>Total Tools</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.total}</div>
        </div>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>In Use</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.inUse}</div>
        </div>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>Overdue</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.overdue}</div>
        </div>
        <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
          <div style={{ color: '#6b7280', fontSize: 12 }}>Expired Tags</div>
          <div style={{ fontSize: 24, fontWeight: 800 }}>{counts.expired}</div>
        </div>
      </div>

      <div style={{ display: 'flex', gap: 8, marginTop: 16, flexWrap: 'wrap' }}>
        {TABS.map(t => (
          <button
            key={t.key}
            onClick={() => setTab(t.key)}
            style={{
              padding: '8px 12px',
              borderRadius: 999,
              border: '1px solid #d1d5db',
              background: tab === t.key ? '#111827' : 'white',
              color: tab === t.key ? 'white' : '#111827',
              cursor: 'pointer',
              fontWeight: 600
            }}
          >
            {t.label}
          </button>
        ))}
      </div>

      {busy && <div style={{ marginTop: 16 }}>Loading…</div>}
      {err && (
        <div style={{ marginTop: 16, background: '#fee2e2', border: '1px solid #fecaca', color: '#991b1b', padding: 12, borderRadius: 10 }}>
          <div style={{ fontWeight: 800 }}>Data load failed</div>
          <pre style={{ marginTop: 8, fontSize: 12, whiteSpace: 'pre-wrap' }}>{err}</pre>
        </div>
      )}

      {!busy && !err && (
        <div style={{ marginTop: 16, display: 'grid', gap: 12 }}>
          {filtered.map(item => (
            <div key={item.id} style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: 12, padding: 14 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', gap: 12, flexWrap: 'wrap' }}>
                <div>
                  <div style={{ fontWeight: 800 }}>{item.name}</div>
                  <div style={{ color: '#6b7280', marginTop: 2 }}>
                    Asset: {item.asset_id} · Category: {item.category || '-'} · Status: {item.computed_status}
                  </div>
                </div>

                <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                  {item.test_tag_state && (
                    <span style={{ fontSize: 12, padding: '4px 10px', borderRadius: 999, border: '1px solid #d1d5db' }}>
                      Tag: {item.test_tag_state}
                    </span>
                  )}
                </div>
              </div>

              {(item.computed_status !== 'available') && (
                <div style={{ marginTop: 10, color: '#374151', fontSize: 14 }}>
                  Checked out to <b>{item.checked_out_to || '-'}</b> at <b>{item.site || '-'}</b>. Expected return: <b>{item.expected_return_at ? new Date(item.expected_return_at).toLocaleString() : '-'}</b>
                </div>
              )}
            </div>
          ))}

          {filtered.length === 0 && (
            <div style={{ color: '#6b7280' }}>No tools found.</div>
          )}
        </div>
      )}
    </div>
  );
}
